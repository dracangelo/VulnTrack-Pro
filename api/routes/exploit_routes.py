from flask import Blueprint, jsonify, request
from api.services.exploit_service import ExploitService
from api.services.cve_service import CVEService
from api.services.vuln_enrichment_service import VulnEnrichmentService

exploit_bp = Blueprint('exploits', __name__, url_prefix='/api/exploits')

@exploit_bp.route('/search', methods=['GET'])
def search_exploits():
    query = request.args.get('query')
    if not query:
        return jsonify({'error': 'Query parameter required'}), 400
        
    service = ExploitService()
    results = service.search_exploits(query)
    
    if isinstance(results, dict) and 'error' in results:
        return jsonify(results), 500
        
    return jsonify(results)

@exploit_bp.route('/run', methods=['POST'])
def run_poc():
    data = request.get_json()
    if not data:
        return jsonify({'error': 'Invalid data'}), 400
        
    target_ip = data.get('target_ip')
    script_content = data.get('script_content')
    script_type = data.get('script_type', 'python')
    
    if not target_ip or not script_content:
        return jsonify({'error': 'target_ip and script_content are required'}), 400
        
    service = ExploitService()
    result = service.run_poc(target_ip, script_content, script_type)
    
    return jsonify(result)

@exploit_bp.route('/cve/<cve_id>/nuclei', methods=['GET'])
def get_nuclei_templates(cve_id):
    service = CVEService()
    templates = service.find_nuclei_templates(cve_id)
    return jsonify(templates)

@exploit_bp.route('/cve/<cve_id>/details', methods=['GET'])
def get_cve_details(cve_id):
    service = CVEService()
    details = service.get_cve_details(cve_id)
    return jsonify(details)

@exploit_bp.route('/cve/<cve_id>/enrich', methods=['GET'])
def enrich_cve(cve_id):
    """Get comprehensive CVE enrichment data"""
    service = CVEService()
    enrichment = service.enrich_cve_data(cve_id)
    return jsonify(enrichment)

@exploit_bp.route('/vulnerability/<int:vuln_id>/exploits', methods=['GET'])
def get_vulnerability_exploits(vuln_id):
    """Get all available exploits for a vulnerability"""
    service = VulnEnrichmentService()
    exploits = service.match_exploits_to_vulnerability(vuln_id)
    return jsonify(exploits)

@exploit_bp.route('/vulnerability/<int:vuln_id>/enrich', methods=['POST'])
def enrich_vulnerability(vuln_id):
    """Manually trigger vulnerability enrichment"""
    service = VulnEnrichmentService()
    result = service.enrich_vulnerability(vuln_id)
    return jsonify(result)

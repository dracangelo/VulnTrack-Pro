import subprocess
import os
import tempfile
import json
import shlex

class ExploitService:
    def search_exploits(self, query):
        """
        Search for exploits using searchsploit.
        """
        if not query:
            return []
            
        try:
            # Run searchsploit with JSON output
            cmd = ['searchsploit', '--json', query]
            result = subprocess.run(cmd, capture_output=True, text=True)
            
            if result.returncode != 0:
                return {'error': f"Searchsploit failed: {result.stderr}"}
                
            output = json.loads(result.stdout)
            return output.get('RESULTS_EXPLOIT', [])
        except Exception as e:
            return {'error': str(e)}

    def run_poc(self, target_ip, script_content, script_type='python'):
        """
        Run a custom PoC script against a target.
        """
        if not target_ip or not script_content:
            return {'error': 'Target IP and script content are required'}
            
        # Create a temporary file for the script
        suffix = '.py' if script_type == 'python' else '.sh'
        with tempfile.NamedTemporaryFile(mode='w', suffix=suffix, delete=False) as temp_file:
            temp_file.write(script_content)
            temp_path = temp_file.name
            
        try:
            # Determine command
            if script_type == 'python':
                cmd = ['python3', temp_path, target_ip]
            else:
                os.chmod(temp_path, 0o755)
                cmd = ['bash', temp_path, target_ip]
                
            # Run the script with timeout
            result = subprocess.run(cmd, capture_output=True, text=True, timeout=30)
            
            return {
                'stdout': result.stdout,
                'stderr': result.stderr,
                'returncode': result.returncode
            }
        except subprocess.TimeoutExpired:
            return {'error': 'Script execution timed out (30s limit)'}
        except Exception as e:
            return {'error': str(e)}
        finally:
            # Clean up temp file
            if os.path.exists(temp_path):
                os.unlink(temp_path)

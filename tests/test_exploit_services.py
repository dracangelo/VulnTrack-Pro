import unittest
from unittest.mock import MagicMock, patch
from api.services.exploit_service import ExploitService
from api.services.cve_service import CVEService

class TestExploitService(unittest.TestCase):
    def setUp(self):
        self.service = ExploitService()

    @patch('subprocess.run')
    def test_search_exploits(self, mock_run):
        # Mock searchsploit output
        mock_output = {
            'RESULTS_EXPLOIT': [
                {'Title': 'Test Exploit', 'Type': 'remote', 'Platform': 'linux'}
            ]
        }
        mock_run.return_value = MagicMock(
            returncode=0,
            stdout='{"RESULTS_EXPLOIT": [{"Title": "Test Exploit", "Type": "remote", "Platform": "linux"}]}',
            stderr=''
        )
        
        results = self.service.search_exploits('test')
        self.assertEqual(len(results), 1)
        self.assertEqual(results[0]['Title'], 'Test Exploit')

    @patch('subprocess.run')
    def test_run_poc(self, mock_run):
        mock_run.return_value = MagicMock(
            returncode=0,
            stdout='PoC Output',
            stderr=''
        )
        
        result = self.service.run_poc('127.0.0.1', 'print("test")', 'python')
        self.assertEqual(result['stdout'], 'PoC Output')

class TestCVEService(unittest.TestCase):
    def setUp(self):
        self.service = CVEService()

    @patch('os.walk')
    def test_find_nuclei_templates(self, mock_walk):
        # Mock os.walk to return a matching template
        mock_walk.return_value = [
            ('/tmp/templates', [], ['cve-2021-44228.yaml'])
        ]
        
        # Mock self.templates_dir
        self.service.templates_dir = '/tmp/templates'
        
        with patch('builtins.open', unittest.mock.mock_open(read_data='name: Log4j RCE')):
            results = self.service.find_nuclei_templates('CVE-2021-44228')
            
        self.assertEqual(len(results), 1)
        self.assertEqual(results[0]['name'], 'Log4j RCE')

if __name__ == '__main__':
    unittest.main()
